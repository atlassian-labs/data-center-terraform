# Installation

This guide describes how to provision the cloud environment infrastructure and install Atlassian Data Center products in a Kubernetes cluster running on AWS.

!!! info "Supported Atlassian Data Center products"
    Currently, only Bamboo Data Center is supported. We are planning to to add support for more Data Center products in the future.

## 1. Set up AWS security credentials

Set up a user with an administrator IAM role. See [Configuration basics â€” AWS Command Line Interface](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html){.external}.

## 2. Clone the project repository

Clone the Terraform for Atlassian DC Products project repository from GitHub:

```shell
git clone https://github.com/atlassian-labs/data-center-terraform.git && cd data-center-terraform
```

## 3. Configure the infrastructure

Configure the infrastructure for the selected product or products by opening the configuration file in a text editor and defining the required values. See [Configuration](CONFIGURATION.md).

!!! info "Where is the configuration file?"
    By default, Terraform uses the `config.tfvars` file in the project root to configure the infrastructure during the installation or uninstallation processes.
       
!!! tip "Can I use a custom configuration file?"
    You can use a custom configuration file, but it must follow the same format as the default configuration file. You can make a copy of `config.tfvars`, using it as a template to define your infrastructure configuration.
    
!!! Warning "Use the same configuration file for uninstallation and cleanup"  
    If you have more than one environment, make sure to manage the configuration file for each environment separately. When cleaning up your environment, use the same configuration file that was used to create it originally.

## 4. Run the installation script

The installation script provisions the environment infrastructure and installs the selected products based on the passed configuration file.

The installation is unattended and invokes Terraform to handle the creation and management of the Kubernetes infrastructure. To keep track of the current state of the resources and manage changes, Terraform creates an S3 bucket to store the current state of the environment. A DynamoDB table is created to handle the locking of remote state files during installation, upgrade, and cleanup to prevent the environment from being modified by more than one process at a time. 
 
The installation script is located in the root directory.

Usage:
=======
The installation script is located in the root folder of the project.

Usage:  

```shell
./install.sh [-c <config-file] [-h]
```

The following options are available:

- `-c <config_file>` - Pass a custom configuration file when provisioning multiple environments
- `-h` - Display help information

Running the installation script with no parameters will use the default configuration file to provision the environment. 

### Start the installation using the default configuration file

To provision the infrastructure using the default `config.tfvars` file, run:

```shell
./install.sh
```

### Start the installation using a custom configuration file

If you want to use a custom configuration file to handle more than one environment, run:

```shell
./install.sh -c <config_file_path>
```

!!! help "How to run the product after installation?"    
    When the installation process finishes successfully, you can find some detailed information about the infrastructure on your console including the endpoint url (`product_urls`/`load_balancer_hostname`) to open the product on your browser and more.      

!!! help "Where do I find the database username and password?"
    The database master username and password for each product are generated by Terraform and saved in a Kubernetes secret in the product namespace.

    To access the database username and password, run the following commands:
    ```
    DB_SECRETS=$(kubectl get secret <product-name>-db-cred -n <product-name> -o jsonpath='{.data}')
    DB_USERNAME=$(echo $DB_SECRETS | jq -r '.username' | base64 --decode)
    DB_PASSWORD=$(echo $DB_SECRETS | jq -r '.password' | base64 --decode)
    ``` 

    This saves the decoded username and password to the `$DB_USERNAME` and `$DB_PASSWORD` environment variables respectively.