# Troubleshooting tips

This guide contains general tips on how to investigate an application deployment that doesn't work correctly.

## Clean up Terraform state

Terraform stores the lock and current state in `terraform-backend.tf`. 
This file is generated by the installation process based on the content of `config.tfvars`.
During the installation, both the installer and Terraform generate some temporary files that are removed after the environment has been uninstalled.

If you installed an environment and then changed any mandatory configuration settings such as `region` or `environment_name`, then clean up 
all temporary files generated by Terraform before installing a new environment. 

To clean up local Terraform files, run the following command:

```shell
./pkg/scripts/cleanup.sh -t
```

To clean up locally generated variable files, run the following command:

```shell
./pkg/scripts/cleanup.sh -s
```

!!! tip
    You can clean up both the local Terraform files and locally generated variable files by using the `-t` and `-s` switches in one command:
    
    ```shell
    ./pkg/scripts/cleanup.sh -s -t
    ```

!!! info
    Temporary variable files will be regenerated using the configurating file and overriden during the installation process.

## Interrupted uninstallation

### Symptom

If you try to uninstall an environment by using a different configuration file than the one you used to install it or by using a different version of the code, you may encounter some issues during uninstallation.
In most cases, Terraform reports that the resource cannot be removed because it's in use. 

### Solution

Idenity the resource and delete it manually from the AWS console, and then restart the uninstallation process. 

## Issues while accessing AWS

### Symptom

The following error is thrown:

```
Terraform uses 'config.tfvars' to install the infrastructure.
Verifying the config file.
Cleaning all the generated terraform state variable and backend file.
ngh-bamboo' infrastructure deployment is started using config.tfvars.
Terraform state backend/variable files are missing.

An error occurred (ExpiredToken) when calling the GetCallerIdentity operation: The security token included in the request is expired
```

### Solution

Terraform cannot deploy resources to AWS if your security token has expired. Renew your token and retry.

## Issues while acquiring state lock

If user interrupts the the installation or uninstallation process, Terraform won't be able to unlock resources. 
In this case, Terraform is unable to acquire state lock in the next attempt.
 
### Symptom

The following error is thrown:

```
Acquiring state lock. This may take a few moments...

 Error: Error acquiring the state lock

 Error message: ConditionalCheckFailedException: The conditional request failed
 Lock Info:
   ID:        26f7b9a8-4bef-0674-669b-1d90800dea4d
   Path:      atlassian-data-center-terraform-state-xxxxxxxxxx/bamboo-xxxxxxxxxx/terraform.tfstate
   Operation: OperationTypeApply
   Who:       nghazalibeiklar@C02CK0JYMD6V
   Version:   1.0.9
   Created:   2021-11-04 00:50:34.736134 +0000 UTC
   Info:


 Terraform acquires a state lock to protect the state from being written
 by multiple users at the same time. Please resolve the issue above and try
 again. For most commands, you can disable locking with the "-lock=false"
 flag, but this is not recommended.
```

### Solution

Forcibly unlock the state by running the following command:

```shell 
terraform force-unlock <ID>
```

Where `<ID>` is the value that appears in the error message.

!!! hint "Are you still having the lock problem after running `terraform force-unlock`?"
    There are two Terraform locksâ€”one for the infrastructure and another for Terraform state. If running the following 
    command from the repository directory does not unlock the resources, change the directory to `./pkg/tfstate` and retry the same command.


