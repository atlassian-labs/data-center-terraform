# Troubleshooting tips

This guide contains general tips on how to investigate an application deployment that doesn't work correctly.

## Cleanup Terraform state
Terraform stores the lock and current state in the terraform backend file in `terraform-backend.tf`. 
This file will be generated by the install process based on the content of `config.auto.tfvars`.
During the installation both installer and terraform generate some temporary files and all those files will be removed after uninstalling the environment.

If the user has installed an environment and then changed any mandatory configuration items such as `region` or `environment_name` then they should 
cleanup all temporary files generated by terraform before install the new environment. 

To clean-up the local terraform files, run the following command:
```
./pkg/scripts/cleanup.sh -t
```

To clean-up the local generated variable files, run the following command:
```
./pkg/scripts/cleanup.sh -s
```

You can combine both switches in one command to clean-up both generated terraform and variable files:
```
./pkg/scripts/cleanup.sh -s -t
```
!!! info "Temporary variable files will re-generate using the config file and override in install process."

## Uninstall interruption
### Symptom
If you try to uninstall using a different config file than what you used to install the environment or using a different version of the code you may face some problems in uninstall.
Mostly terraform complains the resource cannot be removed because it is used. 

### Solution
In this case identify the resource and delete it manually using AWS console, then re-run uninstall. 


## AWS Access
### Symptom

```
Terraform uses 'config.tfvars' to install the infrastructure.
Verifying the config file.
Cleaning all the generated terraform state variable and backend file.
ngh-bamboo' infrastructure deployment is started using config.tfvars.
Terraform state backend/variable files are missing.

An error occurred (ExpiredToken) when calling the GetCallerIdentity operation: The security token included in the request is expired
```

### Solution
Terraform cannot deploy resources into the AWS cloud if your security token has expired. You will need to renew your token and retry.

## How to unlock terraform
If user interrupts the execution of install or uninstall actions, Terraform never get a chance to unlock the locked resources. 
In this case Terraform cannot capture the lock in next attempt.
 
### Symptom

```
Acquiring state lock. This may take a few moments...

 Error: Error acquiring the state lock

 Error message: ConditionalCheckFailedException: The conditional request failed
 Lock Info:
   ID:        26f7b9a8-4bef-0674-669b-1d90800dea4d
   Path:      atlassian-data-center-terraform-state-xxxxxxxxxx/bamboo-xxxxxxxxxx/terraform.tfstate
   Operation: OperationTypeApply
   Who:       nghazalibeiklar@C02CK0JYMD6V
   Version:   1.0.9
   Created:   2021-11-04 00:50:34.736134 +0000 UTC
   Info:


 Terraform acquires a state lock to protect the state from being written
 by multiple users at the same time. Please resolve the issue above and try
 again. For most commands, you can disable locking with the "-lock=false"
 flag, but this is not recommended.

```
### Solution
To fix this you need to unlock state first by running the following command 
(replace ID with the value from the error message):

```shell 
terraform force-unlock <ID>
```

!!! hint "Are you still having the lock problem after running `terraform force-unlock`?"
    There are two terraform locks, one for infrastructure and another for terraform state. If running the following 
    command from repo folder does not unlock the resources, then change the current path to `./pkg/tfstate` and retry
     the same command.  


