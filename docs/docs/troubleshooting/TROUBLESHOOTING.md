# Troubleshooting tips

This guide contains general tips on how to investigate an application deployment that doesn't work correctly.

## Cleanup Terraform state
Terraform stores the lock and current state in the terraform backend file in `terraform-backend.tf`. 
This file will be generated by the install process based on the content of `config.auto.tfvars`.
If the user changes some key configuration items such as `region` or `environment_name` then you should 
cleanup all temporary files generated by terraform and install modules again. 

To cleanup the local terraform files, run the following command:
```
./pkg/scripts/cleanup.sh -t
```

## How to unlock terraform
If user interrupts the execution of install or uninstall actions, Terraform locked the resources but never get a chance to
 unlock them. In this case in next attempt you may see the following error:
 

```
Acquiring state lock. This may take a few moments...
╷
│ Error: Error acquiring the state lock
│
│ Error message: ConditionalCheckFailedException: The conditional request failed
│ Lock Info:
│   ID:        26f7b9a8-4bef-0674-669b-1d90800dea4d
│   Path:      atlassian-data-center-terraform-state-887764444972/test-bamboo-887764444972/terraform.tfstate
│   Operation: OperationTypeApply
│   Who:       nghazalibeiklar@C02CK0JYMD6V
│   Version:   1.0.9
│   Created:   2021-11-04 00:50:34.736134 +0000 UTC
│   Info:
│
│
│ Terraform acquires a state lock to protect the state from being written
│ by multiple users at the same time. Please resolve the issue above and try
│ again. For most commands, you can disable locking with the "-lock=false"
│ flag, but this is not recommended.
╵
```

To fix this you need to unlock state first by running the following command 
(replace ID with the value from the error message):

```shell 
terraform force-unlock <ID>
```

!!! hint "After running the unlock command still you see the error?"
    There are two terraform locks, one for infrastructure and another for terraform state. If running the following 
    command from repo folder does not unlock the resources, then change the current path to `./pkg/tfstate` and retry
     the same command.  



```
Apply complete! Resources: 2 added, 0 changed, 0 destroyed.
Migrating the terraform state to S3 bucket...
Initializing modules...

Initializing the backend...
Backend configuration changed!

Terraform has detected that the configuration specified for the backend
has changed. Terraform will now check for existing state in the backends.


╷
│ Error: Error inspecting states in the "s3" backend:
│     S3 bucket does not exist.
│
│ The referenced S3 bucket must have been previously created. If the S3 bucket
│ was created within the last minute, please wait for a minute or two and try
│ again.
│
│ Error: NoSuchBucket: The specified bucket does not exist
│ 	status code: 404, request id: 3F7S3ANP7A55ZCEK, host id: AmaDrq2Z7nh4CmUkohphCfpCallxVCUxfz2ovAZNPmzoQCdo7k2LrPC7Wya4X21/wxb7msqWiKw=
│
│
│ Prior to changing backends, Terraform inspects the source and destination
│ states to determine what kind of migration steps need to be taken, if any.
│ Terraform failed to load the states. The data in both the source and the
│ destination remain unmodified. Please resolve the above error and try again.
```