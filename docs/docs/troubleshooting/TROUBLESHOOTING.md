# Troubleshooting tips

This guide contains general tips on how to investigate an application deployment that doesn't work correctly.

## Cleanup Terraform state
Terraform stores the lock and current state in the terraform backend file in `terraform-backend.tf`. 
This file will be generated by the install process based on the content of `config.tfvars`.
During the installation both installer and terraform generate some temporary files and all older files will be removed before updating the environment.

If you need to cleanup all generated files after installation or uninstallation then you can use the cleanup tool.
 
This tool will delete all temporary files generated by terraform before installing the new environment. 

To cleanup the local terraform files, run the following command:
```
./pkg/scripts/cleanup.sh -t
```

To cleanup the local generated variable files, run the following command:
```
./pkg/scripts/cleanup.sh -s
```

You can combine both switches in one command to cleanup both generated terraform and variable files:
```
./pkg/scripts/cleanup.sh -s -t
```
!!! info "Temporary variable files will re-generate using the config file and override in install process."

## Uninstall - Uninstall with no valid terraform state
      
**Symptom**
If you try to uninstall using a different config file than what you used to install the environment or using a different version of the code you may face some problems in uninstall.
Mostly terraform complains the resource cannot be removed because it is used. 

**Solution**
In this case identify the resource and delete it manually using AWS console, then re-run uninstall. 

## Uninstall - Stalled product pod
**Symptom**
Uninstall fails to remove the persistent volume.
```
Error: Persistent volume atlassian-dc-bamboo-share-home-pv still exists (Bound)

Error: context deadline exceeded

Error: Persistent volume claim atlassian-dc-bamboo-share-home-pvc still exists with 
```
**Solution**
If a bamboo pod termination stalls, it will block pvc and pv deletion. 
To fix this problem we need to terminate product pod first and run uninstall command again.
```
kubectl delete pod <bamboo-pod> -n bamboo --force
```
To see the stalled bamboo pod name you can run the following command:
```
kubectl get pods -n bamboo 
```

## Uninstall: suspended ASG
If for any reason Auto Scaling Group gets suspended, AWS does not allow terraform to delete the node group. 

**Symptom**
Uninstall process get interrupted with the following error:
```
Error: error waiting for EKS Node Group (atlas-ng-second-test-cluster:appNode) to delete: unexpected state 'DELETE_FAILED', wanted target ''. last error: 2 errors occurred:
	* i-06a4b4afc9e7a76b0: NodeCreationFailure: Instances failed to join the kubernetes cluster
	* eks-appNode-3ebedddc-2d97-ff10-6c23-4900d1d79599: AutoScalingGroupInvalidConfiguration: Couldn't terminate instances in ASG as Terminate process is suspended
```

**Solution**
Delete the reported Auto Scaling Group in AWS console and run uninstall command again. 

## AWS Access
**Symptom**
In order to use terraform solution to provision the Atlassian Data Center products you need to have an AWS account with admin privilege. 
If you have not logged in as an admin or your AWS token is expired you may receive some permission error such as the following: 
```
Terraform uses 'config.tfvars' to install the infrastructure.
Verifying the config file.
Cleaning all the generated terraform state variable and backend file.
ngh-bamboo' infrastructure deployment is started using config.tfvars.
Terraform state backend/variable files are missing.

An error occurred (ExpiredToken) when calling the GetCallerIdentity operation: The security token included in the request is expired
```

**Solution**
Terraform cannot deploy resources into the AWS cloud if you are have no access to AWS account or the security token has expired. You need to login to your AWS account or renew your token and retry.

## Unlock the Terraform state
If user interrupts the execution of install or uninstall actions, Terraform never get a chance to unlock the locked resources. 
In this case Terraform cannot capture the lock in next attempt.
   
**Symptom**
Terraform cannot acquire the state lock. 

```
Acquiring state lock. This may take a few moments...

 Error: Error acquiring the state lock

 Error message: ConditionalCheckFailedException: The conditional request failed
 Lock Info:
   ID:        26f7b9a8-4bef-0674-669b-1d90800dea4d
   Path:      atlassian-data-center-terraform-state-xxxxxxxxxx/bamboo-xxxxxxxxxx/terraform.tfstate
   Operation: OperationTypeApply
   Who:       nghazalibeiklar@C02CK0JYMD6V
   Version:   1.0.9
   Created:   2021-11-04 00:50:34.736134 +0000 UTC
   Info:


 Terraform acquires a state lock to protect the state from being written
 by multiple users at the same time. Please resolve the issue above and try
 again. For most commands, you can disable locking with the "-lock=false"
 flag, but this is not recommended.

```
**Solution**
To fix this you need to unlock state first by running the following command 
(replace ID with the value from the error message):

```shell 
terraform force-unlock <ID>
```

!!! hint "Are you still having the lock problem after running `terraform force-unlock`?"
    There are two terraform locks, one for infrastructure and another for terraform state. If running the following 
    command from repo folder does not unlock the resources, then change the current path to `./pkg/tfstate` and retry
     the same command.  


