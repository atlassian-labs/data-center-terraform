# Troubleshooting tips

This guide contains general tips on how to investigate an application deployment that doesn't work correctly.

## Cleanup Terraform state
Terraform stores the lock and current state in `terraform-backend.tf`. This file is generated by the installation process based on the content of `config.tfvars`. During the installation, both the installer and Terraform generate some temporary files that are removed after the environment has been uninstalled.

If you installed an environment and then changed any mandatory configuration settings such as `region` or `environment_name`, then clean up all temporary files generated by Terraform before installing a new environment.

To clean up local Terraform files, run the following command:
```shell
./scripts/cleanup.sh -t
```

To clean up locally generated variable files, run the following command:
```shell
./scripts/cleanup.sh -s
```
!!! tip
    You can clean up both the local Terraform files and locally generated variable files by using the '-t' and '-s' switches in one command:
    ```shell
    ./scripts/cleanup.sh -s -t
    ```

!!! info 
    Temporary variable files will be regenerated using the configurating file and overriden during the installation process.
    

## Uninstall - Invalid configuration file   
  
**Symptom**
If you try to uninstall an environment by using a different configuration file than the one you used to install it or by using a different version of the code, you may encounter some issues during uninstallation. In most cases, Terraform reports that the resource cannot be removed because it's in use.

**Solution**
Idenity the resource and delete it manually from the AWS console, and then restart the uninstallation process.

!!! tip
    Always use the same configuration file in uninstallation that you used to install the environment. 
    
## Uninstall - Stalled product pod
**Symptom**
Uninstall fails to remove the persistent volume.
```shell
Error: Persistent volume atlassian-dc-bamboo-share-home-pv still exists (Bound)

Error: context deadline exceeded

Error: Persistent volume claim atlassian-dc-bamboo-share-home-pvc still exists with 
```
**Solution**
If a bamboo pod termination stalls, it will block pvc and pv deletion. 
To fix this problem we need to terminate product pod first and run uninstall command again.
```shell
kubectl delete pod <bamboo-pod> -n bamboo --force
```
To see the stalled Bamboo pod name you can run the following command:
```shell
kubectl get pods -n bamboo 
```

## Uninstall: Suspended ASG
If for any reason Auto Scaling Group gets suspended, AWS does not allow Terraform to delete the node group. 

**Symptom**
Uninstall process gets interrupted with the following error:
```shell
Error: error waiting for EKS Node Group (atlas-ng-second-test-cluster:appNode) to delete: unexpected state 'DELETE_FAILED', wanted target ''. last error: 2 errors occurred:
	* i-06a4b4afc9e7a76b0: NodeCreationFailure: Instances failed to join the kubernetes cluster
	* eks-appNode-3ebedddc-2d97-ff10-6c23-4900d1d79599: AutoScalingGroupInvalidConfiguration: Couldn't terminate instances in ASG as Terminate process is suspended
```

**Solution**
Delete the reported Auto Scaling Group in AWS console and run uninstall command again. 

## Issues while accessing AWS
**Symptom**

The following error is thrown:

```shell
An error occurred (ExpiredToken) when calling the GetCallerIdentity operation: The security token included in the request is expired
```

**Solution**

Terraform cannot deploy resources to AWS if your security token has expired. Renew your token and retry.

## Issues while acquiring state lock
If user interrupts the the installation or uninstallation process, Terraform won't be able to unlock resources. In this case, Terraform is unable to acquire state lock in the next attempt.
   
**Symptom**
The following error is thrown:

```shell
Acquiring state lock. This may take a few moments...

 Error: Error acquiring the state lock

 Error message: ConditionalCheckFailedException: The conditional request failed
 Lock Info:
   ID:        26f7b9a8-1bef-0674-669b-1d60800dea4d
   Path:      atlassian-data-center-terraform-state-xxxxxxxxxx/bamboo-xxxxxxxxxx/terraform.tfstate
   Operation: OperationTypeApply
   Who:       xxxxxxxxxx@C02CK0JYMD6V
   Version:   1.0.9
   Created:   2021-11-04 00:50:34.736134 +0000 UTC
   Info:
```

**Solution**
Forcibly unlock the state by running the following command:

```shell 
terraform force-unlock <ID>
```

Where '<ID>' is the value that appears in the error message.

!!! hint "Are you still having the lock problem after running `terraform force-unlock`?"
    There are two Terraform locksâ€”one for the infrastructure and another for Terraform state. If running the following command from the repository directory does not unlock the resources, change the directory to `./modules/tfstate` and retry the same command.

## Pre-existing state in multiple environment

If you start installing an environment while you already have an active environment installed before, you should not use pre-existing state. 
The same scenario when your active environment (the latest environment you installed or uninstalled). 
If you use pre-existing state in install or uninstall an environment you may face with an error in the process.    

!!! hint "Tip"
    Answer 'yes' when you get a similar message during installation or uninstallation:
    ```shellscript
    Do you want to copy existing state to the new backend? Pre-existing state was found while migrating 
    the previous "s3" backend to the newly configured "s3" backend. An existing non-empty state already 
    exists in the new backend. The two states have been saved to temporary files that will be removed 
    after responding to this query. 
    
    Do you want to overwrite the state in the new backend with the previous state? Enter "yes" to copy 
    and "no" to start with the existing state in the newly configured "s3" backend.
    
    Enter a value:
    ```
     

**Symptom**

Installation or uninstallation break after you chose to use pre-existing state. 


**Solution**

1. Clean up everything before proceed. In repository root directory, run:
```shell
./scripts/cleanup.sh -s -t -x -r .
```
2. In repository root directory, run `terraform init -var-file=<config file>`
3. re-run the install/uninstall script.


