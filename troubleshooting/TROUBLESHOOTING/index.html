<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=../../assets/logos/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-8.2.16"><title>Troubleshooting tips - Deployment Automation for Atlassian DC on Kubernetes</title><link rel=stylesheet href=../../assets/stylesheets/main.1c3799f8.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.cc9b2e1e.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-9EV9WQVD44"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-9EV9WQVD44",{page_path:e.pathname})})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-9EV9WQVD44"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary data-md-color-accent> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#troubleshooting-tips class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <a href=https://community.atlassian.com/t5/Atlassian-Data-Center-on/gh-p/DC_Kubernetes title="Share your feedback with the Atlassian Data Center on Kubernetes Community" style=color:white><strong>Share your feedback and join the discussion</strong></a> </div> </aside> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Deployment Automation for Atlassian DC on Kubernetes" class="md-header__button md-logo" aria-label="Deployment Automation for Atlassian DC on Kubernetes" data-md-component=logo> <img src=../../assets/logos/atlassian-logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Deployment Automation for Atlassian DC on Kubernetes </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Troubleshooting tips </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary data-md-color-accent aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary data-md-color-accent aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/atlassian-labs/data-center-terraform title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> atlassian-labs/data-center-terraform </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../userguide/PREREQUISITES/ class=md-tabs__link> User guide </a> </li> <li class=md-tabs__item> <a href=./ class="md-tabs__link md-tabs__link--active"> Troubleshooting </a> </li> <li class=md-tabs__item> <a href=../../development/HOW_TO_START/ class=md-tabs__link> Development </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Deployment Automation for Atlassian DC on Kubernetes" class="md-nav__button md-logo" aria-label="Deployment Automation for Atlassian DC on Kubernetes" data-md-component=logo> <img src=../../assets/logos/atlassian-logo.svg alt=logo> </a> Deployment Automation for Atlassian DC on Kubernetes </label> <div class=md-nav__source> <a href=https://github.com/atlassian-labs/data-center-terraform title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> atlassian-labs/data-center-terraform </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> User guide <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="User guide" data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> User guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../userguide/PREREQUISITES/ class=md-nav__link> Prerequisites </a> </li> <li class=md-nav__item> <a href=../../userguide/INSTALLATION/ class=md-nav__link> Installation </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_3 type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3> Configuration <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Configuration data-md-level=2> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../userguide/configuration/CONFIGURATION/ class=md-nav__link> Common configuration </a> </li> <li class=md-nav__item> <a href=../../userguide/configuration/BAMBOO_CONFIGURATION/ class=md-nav__link> Bamboo configuration </a> </li> <li class=md-nav__item> <a href=../../userguide/configuration/BITBUCKET_CONFIGURATION/ class=md-nav__link> Bitbucket configuration </a> </li> <li class=md-nav__item> <a href=../../userguide/configuration/CONFLUENCE_CONFIGURATION/ class=md-nav__link> Confluence configuration </a> </li> <li class=md-nav__item> <a href=../../userguide/configuration/JIRA_CONFIGURATION/ class=md-nav__link> Jira configuration </a> </li> <li class=md-nav__item> <a href=../../userguide/configuration/CROWD_CONFIGURATION/ class=md-nav__link> Crowd configuration </a> </li> <li class=md-nav__item> <a href=../../userguide/configuration/DCAPT_CONFIGURATION/ class=md-nav__link> DCAPT Configuration </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../userguide/CLEANUP/ class=md-nav__link> Uninstallation </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3> Troubleshooting <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Troubleshooting data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Troubleshooting </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Troubleshooting tips <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Troubleshooting tips </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../SUPPORT_BOUNDARIES/ class=md-nav__link> Support boundaries </a> </li> <li class=md-nav__item> <a href=../LIMITATIONS/ class=md-nav__link> Limitations </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Development <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Development data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Development </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../development/HOW_TO_START/ class=md-nav__link> How to start development </a> </li> <li class=md-nav__item> <a href=../../development/HOW_TO_TEST/ class=md-nav__link> Testing </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> </a> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/atlassian-labs/data-center-terraform/edit/main/docs/docs/troubleshooting/TROUBLESHOOTING.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1 id=troubleshooting-tips>Troubleshooting tips<a class=headerlink href=#troubleshooting-tips title="Permanent link"> ¶</a></h1> <p>This guide contains general tips on how to investigate an application deployment that doesn't work correctly.</p> <details class=tip> <summary>How to troubleshoot a failed Helm release installation?</summary> <h6 id=_1><a id=tip#1></a><a class=headerlink href=#_1 title="Permanent link"> ¶</a></h6> <p><strong>Symptom</strong></p> <p>Install script fails due to failure when installing Helm release. This applies to all DC products. You will see the following error:</p> <div class=highlight><pre><span></span><code>module.confluence[0].helm_release.confluence: Still creating... [20m10s elapsed]
Warning: Helm release &quot;confluence&quot; was created but has a failed status. Use the `helm` command to investigate the error, correct it, then run Terraform again.
  with module.confluence[0].helm_release.confluence,
  on modules/products/confluence/helm.tf line 4, in resource &quot;helm_release&quot; &quot;confluence&quot;:

  4: resource &quot;helm_release&quot; &quot;confluence&quot; {

Error: timed out waiting for the condition
  with module.confluence[0].helm_release.confluence,
  on modules/products/confluence/helm.tf line 4, in resource &quot;helm_release&quot; &quot;confluence&quot;:

4: resource &quot;helm_release&quot; &quot;confluence&quot; {
Releasing state lock. This may take a few moments...
</code></pre></div> <p>Helm gives up waiting for a successful release, Usually, it means that Confluence (or any other product) pod failed to pass its readiness probe, or the pod is stuck in a Pending state.</p> <p><strong>Solution</strong></p> <p>To troubleshoot the error, run the following script:</p> <div class=highlight><pre><span></span><code>scripts/collect_k8s_logs.sh atlas-dcapt-confluence-small-cluster us-east-2 /path/to/local/directory
</code></pre></div> <p>Cluster name and region may differ (look at environment name and region in your <code>config.tfvars</code>). For example, if your <code>environment_name</code> is <code>dcapt-confluence-small</code>, then your cluster name is <code>atlas-dcapt-confluence-small-cluster</code>. The last argument is a destination path for a tar.gz with logs that the script will produce.</p> <p>Share the archive in Slack <a class=external href=http://bit.ly/dcapt_slack>#data-center-app-performance-toolkit</a> channel along with your support request. You can also look at the pod and its logs, e.g.:</p> <div class=highlight><pre><span></span><code>confluence-0_log.log
confluence-0_describe.log
</code></pre></div> <p>Odds are that logs may shed some light on why the pod isn't ready. The <code>product_describe.log</code> file will contain K8S events that may also help understand why the pod isn't in a <code>Running</code> state.</p> <p>It's also a good idea to get logs that are not sent to stdout/err:</p> <div class=highlight><pre><span></span><code>kubectl exec confluence-0 -n atlassian -i -t -- cat /var/atlassian/application-data/confluence/logs/atlassian-confluence.log
</code></pre></div> <p>Typically, if the pod is <code>Running</code> but not marked as <code>Ready</code>, it's the application that failed to start, i.e. it isn't an infrastructure issue.</p> </details> <details class=tip> <summary>How to troubleshoot instances that failed to join the Kubernetes cluster</summary> <h6 id=_2><a id=tip#fail-eks></a><a class=headerlink href=#_2 title="Permanent link"> ¶</a></h6> <p><strong>Symptom</strong></p> <p>When Terraform creates EKS infrastructure, EKS cluster (control plane) is created first. Once the cluster has been created, a NodeGroup (backed by an ASG) is created, and EC2 instances join the cluster as worker nodes.</p> <p>If a node fails to join its cluster, you will typically see the following error:</p> <p><div class=highlight><pre><span></span><code>Error: waiting for EKS Node Group (atlas-dcapt-jira-small-cluster:appNode-t3_xlarge-20240521085758213900000012) to create: unexpected state &#39;CREATE_FAILED&#39;, wanted target &#39;ACTIVE&#39;. last error: 1 error occurred:
* i-0dd1a9dc64303a10b: NodeCreationFailure: Instances failed to join the kubernetes cluster

with module.base-infrastructure.module.eks.module.eks.module.eks_managed_node_group[&quot;appNodes&quot;].aws_eks_node_group.this[0],
on .terraform/modules/base-infrastructure.eks.eks/modules/eks-managed-node-group/main.tf line 272, in resource &quot;aws_eks_node_group&quot; &quot;this&quot;:
272: resource &quot;aws_eks_node_group&quot; &quot;this&quot; {
</code></pre></div> There can be several reasons why nodes can't join the cluster. Permissions issues are the most common. Make sure <a class=external href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp_enable-regions.html>STS is enabled</a> for your account in the target region. With STS disabled, EKS control plane will deny join requests from the nodes.</p> <p>After enabling STS, destroy existing environment and re-run the installation.</p> </details> <details class=tip> <summary>How to fix 'exec plugin is configured to use API version' error?</summary> <h6 id=_3><a id=tip#2></a><a class=headerlink href=#_3 title="Permanent link"> ¶</a></h6> <p><strong>Symptom</strong></p> <p>When running <code>install.sh</code> script the installation fails with an error:</p> <div class=highlight><pre><span></span><code>module.base-infrastructure.kubernetes_namespace.products: Creating...
module.base-infrastructure.module.ingress.helm_release.ingress: Creating...

Error: Post &quot;https://1D2E0AC7AE5EC290740D816BD53A68AB.gr7.us-east-1.eks.amazonaws.com/api/v1/namespaces&quot;: getting credentials: exec plugin is configured to use API version client.authentication.k8s.io/v1beta1, plugin returned version client.authentication.k8s.io/v1alpha1

  with module.base-infrastructure.kubernetes_namespace.products,
  on modules/common/main.tf line 43, in resource &quot;kubernetes_namespace&quot; &quot;products&quot;:
  43: resource &quot;kubernetes_namespace&quot; &quot;products&quot; {


Error: Kubernetes cluster unreachable: Get &quot;https://1D2E0AC7AE5EC290740D816BD53A68AB.gr7.us-east-1.eks.amazonaws.com/version&quot;: getting credentials: decoding stdout: no kind &quot;ExecCredential&quot; is registered for version &quot;client.authentication.k8s.io/v1alpha1&quot; in scheme &quot;pkg/runtime/scheme.go:100&quot;

  with module.base-infrastructure.module.ingress.helm_release.ingress,
  on modules/AWS/ingress/main.tf line 44, in resource &quot;helm_release&quot; &quot;ingress&quot;:
  44: resource &quot;helm_release&quot; &quot;ingress&quot; {
</code></pre></div> <p>The error is caused by API version mismatch. AWS CLI and Kubernetes and Helm providers use <code>v1alpha1</code> and <code>v1beta1</code> respectively.</p> <p><strong>Solution</strong></p> <p>Update AWS CLI to the most recent version.</p> </details> <details class=tip> <summary>How do I uninstall an environment using a different Terraform configuration file?</summary> <h6 id=_4><a id=tip#3></a><a class=headerlink href=#_4 title="Permanent link"> ¶</a></h6> <p><strong>Symptom</strong></p> <p>If you try to uninstall an environment by using a different configuration file than the one you used to install it or by using a different version of the code, you may encounter some issues during uninstallation. In most cases, Terraform reports that the resource cannot be removed because it's in use.</p> <p><strong>Solution</strong></p> <p>Identify the resource and delete it manually from the AWS console, and then restart the uninstallation process. Make sure to always use the same configuration file that was used to install the environment. </p> </details> <details class=tip> <summary>How do I deal with persistent volumes that do not get removed as part of the Terraform uninstallation?</summary> <h6 id=_5><a id=tip#4></a><a class=headerlink href=#_5 title="Permanent link"> ¶</a></h6> <p><strong>Symptom</strong></p> <p>Uninstall fails to remove the persistent volume. <div class=highlight><pre><span></span><code>Error:<span class=w> </span>Persistent<span class=w> </span>volume<span class=w> </span>atlassian-dc-share-home-pv<span class=w> </span>still<span class=w> </span>exists<span class=w> </span><span class=o>(</span>Bound<span class=o>)</span>

Error:<span class=w> </span>context<span class=w> </span>deadline<span class=w> </span>exceeded

Error:<span class=w> </span>Persistent<span class=w> </span>volume<span class=w> </span>claim<span class=w> </span>atlassian-dc-share-home-pvc<span class=w> </span>still<span class=w> </span>exists<span class=w> </span>with<span class=w> </span>
</code></pre></div> <strong>Solution</strong></p> <p>If a pod termination stalls, it will block pvc and pv deletion. To fix this problem we need to terminate product pod first and run uninstall command again. <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>delete<span class=w> </span>pod<span class=w> </span>&lt;stalled-pod&gt;<span class=w> </span>-n<span class=w> </span>atlassian<span class=w> </span>--force
</code></pre></div> To see the stalled pod name you can run the following command: <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>atlassian<span class=w> </span>
</code></pre></div></p> </details> <details class=tip> <summary>How do I deal with suspended AWS Auto Scaling Groups during Terraform uninstallation?</summary> <h6 id=_6><a id=tip#5></a><a class=headerlink href=#_6 title="Permanent link"> ¶</a></h6> <p><strong>Symptom</strong></p> <p>If for any reason Auto Scaling Group gets suspended, AWS does not allow Terraform to delete the node group. In cases like this the uninstall process gets interrupted with the following error:</p> <div class=highlight><pre><span></span><code>Error:<span class=w> </span>error<span class=w> </span>waiting<span class=w> </span><span class=k>for</span><span class=w> </span>EKS<span class=w> </span>Node<span class=w> </span>Group<span class=w> </span><span class=o>(</span>atlas-&lt;environment_name&gt;-cluster:appNode<span class=o>)</span><span class=w> </span>to<span class=w> </span>delete:<span class=w> </span>unexpected<span class=w> </span>state<span class=w> </span><span class=s1>&#39;DELETE_FAILED&#39;</span>,<span class=w> </span>wanted<span class=w> </span>target<span class=w> </span><span class=s1>&#39;&#39;</span>.<span class=w> </span>last<span class=w> </span>error:<span class=w> </span><span class=m>2</span><span class=w> </span>errors<span class=w> </span>occurred:
<span class=w>    </span>*<span class=w> </span>i-06a4b4afc9e7a76b0:<span class=w> </span>NodeCreationFailure:<span class=w> </span>Instances<span class=w> </span>failed<span class=w> </span>to<span class=w> </span>join<span class=w> </span>the<span class=w> </span>kubernetes<span class=w> </span>cluster
<span class=w>    </span>*<span class=w> </span>eks-appNode-3ebedddc-2d97-ff10-6c23-4900d1d79599:<span class=w> </span>AutoScalingGroupInvalidConfiguration:<span class=w> </span>Couldn<span class=err>&#39;</span>t<span class=w> </span>terminate<span class=w> </span>instances<span class=w> </span><span class=k>in</span><span class=w> </span>ASG<span class=w> </span>as<span class=w> </span>Terminate<span class=w> </span>process<span class=w> </span>is<span class=w> </span>suspended
</code></pre></div> <p><strong>Solution</strong></p> <p>Delete the reported Auto Scaling Group in AWS console and run uninstall command again. </p> </details> <details class=tip> <summary>How do I deal with Terraform AWS authentication issues during installation?</summary> <h6 id=_7><a id=tip#6></a><a class=headerlink href=#_7 title="Permanent link"> ¶</a></h6> <p><strong>Symptom</strong></p> <p>The following error is thrown:</p> <div class=highlight><pre><span></span><code>An<span class=w> </span>error<span class=w> </span>occurred<span class=w> </span><span class=o>(</span>ExpiredToken<span class=o>)</span><span class=w> </span>when<span class=w> </span>calling<span class=w> </span>the<span class=w> </span>GetCallerIdentity<span class=w> </span>operation:<span class=w> </span>The<span class=w> </span>security<span class=w> </span>token<span class=w> </span>included<span class=w> </span><span class=k>in</span><span class=w> </span>the<span class=w> </span>request<span class=w> </span>is<span class=w> </span>expired
</code></pre></div> <p><strong>Solution</strong></p> <p>Terraform cannot deploy resources to AWS if your security token has expired. Renew your token and retry.</p> </details> <details class=tip> <summary>How do I deal with Terraform state lock acquisition errors?</summary> <h6 id=_8><a id=tip#7></a><a class=headerlink href=#_8 title="Permanent link"> ¶</a></h6> <p>If user interrupts the installation or uninstallation process, Terraform won't be able to unlock resources. In this case, Terraform is unable to acquire state lock in the next attempt.</p> <p><strong>Symptom</strong></p> <p>The following error is thrown:</p> <div class=highlight><pre><span></span><code>Acquiring<span class=w> </span>state<span class=w> </span>lock.<span class=w> </span>This<span class=w> </span>may<span class=w> </span>take<span class=w> </span>a<span class=w> </span>few<span class=w> </span>moments...

<span class=w> </span>Error:<span class=w> </span>Error<span class=w> </span>acquiring<span class=w> </span>the<span class=w> </span>state<span class=w> </span>lock

<span class=w> </span>Error<span class=w> </span>message:<span class=w> </span>ConditionalCheckFailedException:<span class=w> </span>The<span class=w> </span>conditional<span class=w> </span>request<span class=w> </span>failed
<span class=w> </span>Lock<span class=w> </span>Info:
<span class=w>   </span>ID:<span class=w>        </span>26f7b9a8-1bef-0674-669b-1d60800dea4d
<span class=w>   </span>Path:<span class=w>      </span>atlassian-data-center-terraform-state-xxxxxxxxxx/bamboo-xxxxxxxxxx/terraform.tfstate
<span class=w>   </span>Operation:<span class=w> </span>OperationTypeApply
<span class=w>   </span>Who:<span class=w>       </span>xxxxxxxxxx@C02CK0JYMD6V
<span class=w>   </span>Version:<span class=w>   </span><span class=m>1</span>.0.9
<span class=w>   </span>Created:<span class=w>   </span><span class=m>2021</span>-11-04<span class=w> </span><span class=m>00</span>:50:34.736134<span class=w> </span>+0000<span class=w> </span>UTC
<span class=w>   </span>Info:
</code></pre></div> <p><strong>Solution</strong></p> <p>Forcibly unlock the state by running the following command:</p> <div class=highlight><pre><span></span><code>terraform<span class=w> </span>force-unlock<span class=w> </span>&lt;ID&gt;
</code></pre></div> <p>Where <code>&lt;ID&gt;</code> is the value that appears in the error message.</p> <p>There are two Terraform locks; one for the infrastructure and another for Terraform state. If you are still experiencing lock issues, change the directory to <code>./modules/tfstate</code> and retry the same command.</p> </details> <details class=tip> <summary>How do I deal with state data in S3 that does not have the expected content?</summary> <h6 id=_9><a id=tip#8></a><a class=headerlink href=#_9 title="Permanent link"> ¶</a></h6> <p>If Terraform state is locked and users forcefully unlock it using <code>terraform force-unlock &lt;id&gt;</code>, it may not get a chance to update the Digest value in DynamoDB. This prevents Terraform from reading the state data. </p> <p><strong>Symptom</strong></p> <p>The following error is thrown:</p> <div class=highlight><pre><span></span><code>Error<span class=w> </span>refreshing<span class=w> </span>state:<span class=w> </span>state<span class=w> </span>data<span class=w> </span><span class=k>in</span><span class=w> </span>S3<span class=w> </span>does<span class=w> </span>not<span class=w> </span>have<span class=w> </span>the<span class=w> </span>expected<span class=w> </span>content.

This<span class=w> </span>may<span class=w> </span>be<span class=w> </span>caused<span class=w> </span>by<span class=w> </span>unusually<span class=w> </span>long<span class=w> </span>delays<span class=w> </span><span class=k>in</span><span class=w> </span>S3<span class=w> </span>processing<span class=w> </span>a<span class=w> </span>previous<span class=w> </span>state
update.<span class=w>  </span>Please<span class=w> </span><span class=nb>wait</span><span class=w> </span><span class=k>for</span><span class=w> </span>a<span class=w> </span>minute<span class=w> </span>or<span class=w> </span>two<span class=w> </span>and<span class=w> </span>try<span class=w> </span>again.<span class=w> </span>If<span class=w> </span>this<span class=w> </span>problem
persists,<span class=w> </span>and<span class=w> </span>neither<span class=w> </span>S3<span class=w> </span>nor<span class=w> </span>DynamoDB<span class=w> </span>are<span class=w> </span>experiencing<span class=w> </span>an<span class=w> </span>outage,<span class=w> </span>you<span class=w> </span>may<span class=w> </span>need
to<span class=w> </span>manually<span class=w> </span>verify<span class=w> </span>the<span class=w> </span>remote<span class=w> </span>state<span class=w> </span>and<span class=w> </span>update<span class=w> </span>the<span class=w> </span>Digest<span class=w> </span>value<span class=w> </span>stored<span class=w> </span><span class=k>in</span><span class=w> </span>the
DynamoDB<span class=w> </span>table<span class=w> </span>to<span class=w> </span>the<span class=w> </span>following<span class=w> </span>value:<span class=w> </span>531ca9bce76bbe0262f610cfc27bbf0b
</code></pre></div> <p><strong>Solution</strong></p> <ol> <li> <p>Open DynamoDB page in AWS console and find the table named <code>atlassian_data_center_&lt;region&gt;_&lt;aws_account_id&gt;_tf_lock</code> in the same region as the cluster.</p> </li> <li> <p>Click on <code>Explore Table Items</code> and find the LockID named <code>&lt;table_name&gt;/&lt;environment_name&gt;/terraform.tfstate-md5</code>. </p> </li> <li> <p>Click on the item and replace the <code>Digest</code> value with the given value in the error message.</p> </li> </ol> </details> <details class=tip> <summary>How do I deal with pre-existing state in multiple environment?</summary> <h6 id=_10><a id=tip#9></a><a class=headerlink href=#_10 title="Permanent link"> ¶</a></h6> <p>If you start installing a new environment while you already have an active environment installed before, you should <em>NOT</em> use the pre-existing state. </p> <p>The same scenario when you want to uninstall a non-active environment. </p> <div class="admonition help"> <p class=admonition-title>What is active environment?</p> <p>Active environment is the latest environment you installed or uninstalled.</p> </div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Answer '<strong>NO</strong>' when you get a similar message during installation or uninstallation: <div class=highlight><pre><span></span><code>Do you want to copy existing state to the new backend? Pre-existing state was found while migrating 
the previous &quot;s3&quot; backend to the newly configured &quot;s3&quot; backend. An existing non-empty state already 
exists in the new backend. The two states have been saved to temporary files that will be removed 
after responding to this query. 

Do you want to overwrite the state in the new backend with the previous state? Enter &quot;yes&quot; to copy 
and &quot;no&quot; to start with the existing state in the newly configured &quot;s3&quot; backend.

Enter a value:
</code></pre></div></p> </div> <p><strong>Symptom</strong></p> <p>Installation or uninstallation break after you chose to use pre-existing state. </p> <p><strong>Solution</strong></p> <ol> <li>Clean up the project before proceed. In root directory of the project run: <div class=highlight><pre><span></span><code>./scripts/cleanup.sh<span class=w> </span>-s<span class=w> </span>-t<span class=w> </span>-x<span class=w> </span>-r<span class=w> </span>.
terraform<span class=w> </span>init<span class=w> </span>-var-file<span class=o>=</span>&lt;config<span class=w> </span>file&gt;
</code></pre></div></li> <li>Then re-run the install/uninstall script.</li> </ol> </details> <details class=tip> <summary>How do I deal with <code>Module not installed</code> error during uninstallation?</summary> <h6 id=_11><a id=tip#10></a><a class=headerlink href=#_11 title="Permanent link"> ¶</a></h6> <p>There are some Terraform specific modules that are required when performing an uninstall. These modules are generated by Terraform during the install process and are stored in the <code>.terraform</code> folder. If Terraform cannot find these modules, then it won't be able perform an uninstall of the infrastructure. </p> <p><strong>Symptom</strong></p> <div class=highlight><pre><span></span><code>Error:<span class=w> </span>Module<span class=w> </span>not<span class=w> </span>installed

<span class=w>  </span>on<span class=w> </span>main.tf<span class=w> </span>line<span class=w> </span><span class=m>7</span>:
<span class=w>   </span><span class=m>7</span>:<span class=w> </span>module<span class=w> </span><span class=s2>&quot;tfstate-bucket&quot;</span><span class=w> </span><span class=o>{</span>

This<span class=w> </span>module<span class=w> </span>is<span class=w> </span>not<span class=w> </span>yet<span class=w> </span>installed.<span class=w> </span>Run<span class=w> </span><span class=s2>&quot;terraform init&quot;</span><span class=w> </span>to<span class=w> </span>install<span class=w> </span>all<span class=w> </span>modules<span class=w> </span>required<span class=w> </span>by<span class=w> </span>this<span class=w> </span>configuration.
</code></pre></div> <p><strong>Solution</strong></p> <ol> <li>In the root directory of the project run: <div class=highlight><pre><span></span><code>./scripts/cleanup.sh<span class=w> </span>-s<span class=w> </span>-t<span class=w> </span>-x<span class=w> </span>-r<span class=w> </span>.
<span class=nb>cd</span><span class=w> </span>modules/tfstate
terraform<span class=w> </span>init<span class=w> </span>-var-file<span class=o>=</span>&lt;config<span class=w> </span>file&gt;
</code></pre></div></li> <li>Go back to the root of the project and re-run the <code>uninstall.sh</code> script.</li> </ol> </details> <details class=tip> <summary>How to deal with <code>getting credentials: exec: executable aws failed with exit code 2</code> error?</summary> <h6 id=_12><a id=tip#11></a><a class=headerlink href=#_12 title="Permanent link"> ¶</a></h6> <p><strong>Symptom</strong></p> <p>After performing an <code>install.sh</code> the following error is encountered:</p> <div class=highlight><pre><span></span><code>Error:<span class=w> </span>Post<span class=w> </span><span class=s2>&quot;https://0839E580E6ADB7B784AECE0E152D8AF2.gr7.eu-west-1.eks.amazonaws.com/api/v1/namespaces&quot;</span>:<span class=w> </span>getting<span class=w> </span>credentials:<span class=w> </span>exec:<span class=w> </span>executable<span class=w> </span>aws<span class=w> </span>failed<span class=w> </span>with<span class=w> </span><span class=nb>exit</span><span class=w> </span>code<span class=w> </span><span class=m>2</span>

with<span class=w> </span>module.base-infrastructure.kubernetes_namespace.products,
on<span class=w> </span>modules/common/main.tf<span class=w> </span>line<span class=w> </span><span class=m>39</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>resource<span class=w> </span><span class=s2>&quot;kubernetes_namespace&quot;</span><span class=w> </span><span class=s2>&quot;products&quot;</span>:
<span class=m>39</span>:<span class=w> </span>resource<span class=w> </span><span class=s2>&quot;kubernetes_namespace&quot;</span><span class=w> </span><span class=s2>&quot;products&quot;</span><span class=w> </span><span class=o>{</span>
</code></pre></div> <p><strong>Solution</strong></p> <p>Ensure you are using a version of the <a href=https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html>aws cli</a> that is at least &gt;= <code>2</code> The version can be checked by running:</p> <div class=highlight><pre><span></span><code>aws<span class=w> </span>--version
</code></pre></div> </details> <details class=tip> <summary>How to <code>ssh</code> to application nodes?</summary> <h6 id=_13><a id=tip#12></a><a class=headerlink href=#_13 title="Permanent link"> ¶</a></h6> <p>Sometimes you need to ssh to the application nodes. This can be done by running:</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span>&lt;pod-name&gt;<span class=w> </span>-n<span class=w> </span>atlassian<span class=w> </span>--<span class=w> </span>/bin/bash
</code></pre></div> <p>where <code>&lt;pod-name&gt;</code> is the name of the application pod you want to ssh such as <code>bitbucket-0</code> or <code>jira-1</code>. To get the pod names you can run:</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>atlassian
</code></pre></div> </details> <details class=tip> <summary>How to access to the application log files?</summary> <h6 id=_14><a id=tip#13></a><a class=headerlink href=#_14 title="Permanent link"> ¶</a></h6> <p>A simple way to access to the application log content is running the following command:</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>logs<span class=w> </span>&lt;pod-name&gt;<span class=w> </span>-n<span class=w> </span>atlassian
</code></pre></div> <p>where <code>&lt;pod-name&gt;</code> is the name of the application pod you want to see the log such as <code>bitbucket-0</code> or <code>jira-1</code>. To get the pod names you can run:</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>atlassian
</code></pre></div> <p>However, another approach to see the full log files produced by the application would be to <code>ssh</code> to the application pod and access directly the log folder.</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span>&lt;pod-name&gt;<span class=w> </span>-n<span class=w> </span>atlassian<span class=w> </span>--<span class=w> </span>/bin/bash
<span class=nb>cd</span><span class=w> </span>/var/atlassian/&lt;application&gt;/logs
</code></pre></div> <p>where <code>&lt;application&gt;</code> is the name of the application such as <code>confluence</code>, <code>bamboo</code>, <code>bitbucket</code>, or <code>jira</code>.</p> <p>Note that for some applications log foler is <code>/var/atlassian/&lt;application&gt;/log</code> and for others is <code>/var/atlassian/&lt;application&gt;/logs</code>.</p> <p>If you need to copy the log files to a local machine, you can use the following command:</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>cp<span class=w> </span>atlassian/&lt;pod-name&gt;:/var/atlassian/&lt;application&gt;/logs/&lt;log_files&gt;<span class=w> </span>&lt;local-path&gt;
</code></pre></div> </details> <details class=tip> <summary>How to deal with persistent volume claim destroy failed error?</summary> <h6 id=_15><a id=tip#14></a><a class=headerlink href=#_15 title="Permanent link"> ¶</a></h6> <p>The PVC cannot be destroyed when bound to a pod. Overcome this by scaling down to <code>0</code> pods first before deleting PVC. </p> <p><code>helm upgrade PRODUCT atlassian-data-center/PRODUCT --set replicaCount=0 --reuse-values -n atlassian</code></p> </details> <details class=tip> <summary>How to manually clean up resources when uninstall has failed?</summary> <h6 id=_16><a id=tip#15></a><a class=headerlink href=#_16 title="Permanent link"> ¶</a></h6> <p>Sometimes Terraform is unable to destroy resources for various reasons. This normally happens at EKS level. One quick solution is to manually delete the EKS cluster, and re-run uninstall, so that Terraform will pick up from there. </p> <p>To delete EKS cluster, go to AWS console &gt; EKS service &gt; the cluster you're deploying. You'll need to go to 'Configuration' tab &gt; 'Compute' tab &gt; click into node group. Then in node group screen &gt; Details &gt; click into Autoscaling group. It'll then direct you to EC2 &gt; Auto Scaling Group screen with the ASG selected &gt; 'Delete' the chosen ASG. Wait for the ASG to be deleted, then go back to EKS cluster &gt; Delete.</p> </details> <details class=tip> <summary>How to deal with <code>This object does not have an attribute named</code> error when running uninstall.sh</summary> <h6 id=_17><a id=tip#16></a><a class=headerlink href=#_17 title="Permanent link"> ¶</a></h6> <p>It is possible that if the installation has failed, the uninstall script will return an error like: <div class=highlight><pre><span></span><code>module.base-infrastructure.module.eks.aws_autoscaling_group_tag.this[&quot;Name&quot;]: Refreshing state... [id=eks-appNode-t3_xlarge-50c26268-ea57-5aee-4523-68f33af7dd71,Name]
Error: Unsupported attribute
on dc-infrastructure.tf line 142, in module &quot;confluence&quot;:
142: ingress = module.base-infrastructure.ingress
├────────────────
│ module.base-infrastructure is object with 5 attributes
This object does not have an attribute named &quot;ingress&quot;.
Error: Unsupported attribute
</code></pre></div> This happens because some of the modules failed to be installed. To fix the error, run the uninstall script with <code>-s</code> argument. This will add <code>-refresh=false</code> to terraform destroy command.</p> </details> <details class=tip> <summary>How to deal with <code>Error: Kubernetes cluster unreachable: the server has asked for the client to provide credentials</code> error</summary> <h6 id=_18><a id=tip#17></a><a class=headerlink href=#_18 title="Permanent link"> ¶</a></h6> <p>It is possible that you see such an error when running uninstall script with <code>-s</code> argument. If it's not possible to destroy infrastructure without it, delete the offending module from tfstate, for example: <div class=highlight><pre><span></span><code>terraform state rm module.base-infrastructure.module.eks.helm_release.cluster-autoscaler
</code></pre></div> Once done, re-run the uninstall script.</p> </details> <details class=tip> <summary>How to deal with EIP AddressLimitExceeded error</summary> <h6 id=_19><a id=tip#18></a><a class=headerlink href=#_19 title="Permanent link"> ¶</a></h6> <p>If you encounter the below error during installation stage, it means VPC is successfully created, but no Elastic IP addresses available. </p> <div class=highlight><pre><span></span><code>Error:<span class=w> </span>Error<span class=w> </span>creating<span class=w> </span>EIP:<span class=w> </span>AddressLimitExceeded:<span class=w> </span>The<span class=w> </span>maximum<span class=w> </span>number<span class=w> </span>of<span class=w> </span>addresses<span class=w> </span>has<span class=w> </span>been<span class=w> </span>reached.
status<span class=w> </span>code:<span class=w> </span><span class=m>400</span>,<span class=w> </span>request<span class=w> </span>id:<span class=w> </span>0061b744-ced3-4d0e-9905-503c85013bcc

with<span class=w> </span>module.base-infrastructure.module.vpc.module.vpc.aws_eip.nat<span class=o>[</span><span class=m>0</span><span class=o>]</span>,
on<span class=w> </span>.terraform/modules/base-infrastructure.vpc.vpc/main.tf<span class=w> </span>line<span class=w> </span><span class=m>1078</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>resource<span class=w> </span><span class=s2>&quot;aws_eip&quot;</span><span class=w> </span><span class=s2>&quot;nat&quot;</span>:
<span class=m>1078</span>:<span class=w> </span>resource<span class=w> </span><span class=s2>&quot;aws_eip&quot;</span><span class=w> </span><span class=s2>&quot;nat&quot;</span><span class=w> </span><span class=o>{</span>
</code></pre></div> <p>It happens when an old VPC was deleted but associated Elastic IPs were not released. Refer to AWS documentation on <a class=external href=https://docs.aws.amazon.com/vpc/latest/userguide/vpc-eips.html#release-eip>how to release an Elastic IP address</a>. </p> <p>Another option is to <a class=external href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html#using-instance-addressing-limit>increase the Elastic UP address limit</a>. </p> </details> <details class=tip> <summary>How to deal with Nginx Ingress Helm deployment error</summary> <h6 id=_20><a id=tip#19></a><a class=headerlink href=#_20 title="Permanent link"> ¶</a></h6> <p>If you encounter the below error when providing 25+ cidrs in <code>whitelist_cidr</code> variable, it may be caused by the service controller being unable to create a Load Balancer due to exceeding the inbound rules quota in a security group:</p> <p><div class=highlight><pre><span></span><code>module.base-infrastructure.module.ingress.helm_release.ingress: Still creating... [5m50s elapsed]
Warning: Helm release &quot;ingress-nginx&quot; was created but has a failed status. Use the `helm` command to investigate the error, correct it, then run Terraform again.
</code></pre></div> To check if it's really the case, login to the cluster and run:</p> <p><div class=highlight><pre><span></span><code>kubectl describe ingress-nginx-controller -n ingress-nginx
</code></pre></div> to find the following error in Events section:</p> <div class=highlight><pre><span></span><code>Warning  SyncLoadBalancerFailed  112s  service-controller  Error syncing load balancer: failed to ensure load balancer: error authorizing security group ingress: &quot;RulesPerSecurityGroupLimitExceeded: The maximum number of rules per security group has been reached.\n\tstatus code: 400, request id: 7de945ea-0571-48cd-99a1-c2ca528ad412&quot;
</code></pre></div> <p>The service controller creates several inbound rules for ports 80 and 443 for each source cidr, and as a result the quota is reached if there are 25+ cidrs in <code>whitelist_cidr</code> list.</p> <p>To mitigate the problem you may either file a ticket with AWS to <a href=https://docs.aws.amazon.com/vpc/latest/userguide/amazon-vpc-limits.html#vpc-limits-security-groups>increase the quota of inbound rules in a security group</a> (60 by default) or set <code>enable_https_ingress</code> to false in <code>config.tfvars</code> if you don't need https ingresses. Port 443 will be removed from Nginx service, and as a result fewer inbound rules are created in the security group.</p> <p>With an increased inbound rules quota or <code>enable_https_ingress</code> set to false (or both), it is recommended to delete Nginx Helm chart before re-running <code>install.sh</code>:</p> <div class=highlight><pre><span></span><code>helm delete ingress-nginx -n ingress-nginx
</code></pre></div> </details> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../userguide/CLEANUP/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Uninstallation" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Uninstallation </div> </div> </a> <a href=../SUPPORT_BOUNDARIES/ class="md-footer__link md-footer__link--next" aria-label="Next: Support boundaries" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Support boundaries </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; [2021] to [2022] Atlassian and others. </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://community.atlassian.com/t5/Atlassian-Data-Center-on/gh-p/DC_Kubernetes target=_blank rel=noopener title=community.atlassian.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M152.2 236.4c-7.7-8.2-19.7-7.7-24.8 2.8L1.6 490.2c-5 10 2.4 21.7 13.4 21.7h175c5.8.1 11-3.2 13.4-8.4 37.9-77.8 15.1-196.3-51.2-267.1zM244.4 8.1c-122.3 193.4-8.5 348.6 65 495.5 2.5 5.1 7.7 8.4 13.4 8.4H497c11.2 0 18.4-11.8 13.4-21.7 0 0-234.5-470.6-240.4-482.3-5.3-10.6-18.8-10.8-25.6.1z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["search.suggest", "search.highlight", "navigation.instant", "navigation.tabs"], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../assets/javascripts/bundle.3a4b43e5.min.js></script> </body> </html>